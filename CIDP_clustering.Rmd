---
title: 'CIDP: clustering based on EDX data'
output:
  html_document:
    df_print: paged
    toc: yes
  word_document:
    toc: yes
  pdf_document:
    toc: yes
  html_notebook:
    theme: journal
    toc: yes
editor_options:
  chunk_output_type: console
---

## 작업 환경설정

set working directory
```{r}
setwd("/Users/hong/Dropbox/CIDP/Data")
```

## 문제 정의

CIDP is usually treated effectively with corticosteroids, intravenous immunoglobulin (IVIg), and plasma exchange (PE).  

> However, 10% to 30% of patients have difficult-to-control disease and eventually have severe disability. 

Several clinical and laboratory features reportedly affect treatment response and long-term disability, including initial disability at diagnosis (Chio, 2007; Spina, 2017), age at onset (Chio, 2007; Spina, 2017), gender (Iijima, 2005), disease duration (Iijima, 2005; Dunnigan, 2014), clinical phenotype (Katz, 2000; Kuwabara, 2014), muscle atrophy (Iijima, 2005), CSF protein increase (Sghirlanzoni, 2000; Tackenberg, 2007), and the presence of auto-antibodies (references).   

> However, previous studies are inconsistent in their results and it is often difficult to predict the treatment outcome. 

Electrodiagnostic (EDX) studies can provide important measures about demyelinating nerve pathology, and the current EDX criteria recommended by the European Federation of Neurological Societies and Peripheral Nerve Society (EFNS–PNS) require demonstration of demyelinating abnormalities for the diagnosis of CIDP.  

> Of note, it has been suggested that EDX studies could also provide prognostically valuable information (references). 

The presence of axonal features such as decreased compound muscle action potential (CMAP) were pronounced in non-responders of IVIg (Bouchard 1999; Sghirlanzoni, 2000; Iijima, 2005). A higher number and degree of demyelinating features were reported to predict higher treatment response rates (Cocito, 2005; Abraham, 2015). The distribution patterns of demyelination were also demonstrated to correlate with clinical profiles and treatment response (Kuwabara, 2002; Kuwabara 2014). 

> Previous studies, however, have analyzed individual EDX parameters separately, so that they are limited in capturing complex patterns within a metric of various conduction parameters. 

Here, we use an unsupervised clustering approach to explore the pattern of EDX conduction abnormalities using the initial data at diagnosis. We also sought to investigate whether the EDX data-driven clustering can identify a distinct subgroup of patients regarding clinical phenotypes and treatment outcome.  

## 데이터 정의

Definite CIDP (2010 EFNS/PNS criteria) diagnosed between January 2004 and August 2015  

Two teaching hospitals (Seoul National University Hospital or Seoul Metropolitan Government Boramae Medical center)   

> treatment outcome: modified rankin disability scales (favorable vs. unfavorable outcome: mRS <= 2 vs. > 2)  

treatment response: responder vs. non-responder (responder if last mRS better than initial mRS, nonresponder if last mRS is worse than initial mRS, if no change in mRS, responder if last mRS <3, otherwise nonresponder)  

clinical subtype: typical, MADSAM, DADS, pure motor, pure sensory  

EDX clusters: hierachical clustering (the optimal number of clusters determined by 30 validation indexes according to majority vote)  
**Clustering is the partitioning of a set of objects into groups (clusters) so that objects within a group are more similar to each others than objects in different groups.**

## 자료 수집

clinical data: demographic, date of symptom onset, date of diagnosis, date of last visit, data on phenotype, subtype, disability (mRS)  

lab data: cerebrospinal fluid (wbc, protein), electrophoresis (M protein, light chain)  

edx data: initial NCS data at dignosis of definite CIDP   

## 데이터 가공

EDX raw data were converted to percentage values relative to upper or lower limit of normal  

For each parameter, mean values were calculated across different limbs

Missing values were imputed (by using random forest algorithm, missForest R package)   

### 데이터 불러오기(Data import)

import datasets 
```{r}
# edx dataset
edx = read.csv("CIDP_EDX_mean.csv", na.strings = c(NA, ""))
# hx, dx, and disability dataset
clinic1 = read.csv("CIDP_hx_dx_disability.csv", na.strings = c("", NA))
# past medical hx, clinical features, lab, tx dataset
clinic2 = read.csv("CIDP_pmhx_fx_lab_tx.csv", na.strings = c("",NA))
```

### 데이터 손질하기(Data processing)

merge dataset 
```{r}
cidp = cbind(edx, clinic1[,-1], clinic2[,-1])
```

# What if MADSAM excluded...  
```{r}
library(dplyr)
#cidp %>%
#  filter(subtype != "MADSAM") -> cidp
edx = cidp[,1:8]
cidp$subtype = droplevels(cidp$subtype)
```

variable type conversion
```{r}
cidp = within(cidp, {
  sex = factor(sex, labels = c("female", "male"))
  dob = as.Date(dob, format="%Y.%m.%d")
  date_onset = as.Date(date_onset, format="%Y.%m.%d")
  date_Dx = as.Date(date_Dx, format="%Y.%m.%d")
  date_lastvisit = as.Date(date_lastvisit, format = "%Y.%m.%d")
  diabetes = factor(diabetes)
  ckd = factor(ckd)
  atrophy = factor(atrophy)
  ataxia = factor(ataxia)
  cNerve = factor(cNerve)
  tremor = factor(tremor)
  M_prot = factor(M_prot)
  steroid = factor(steroid)
  IVIG = factor(IVIG)
  others = factor(others)
})
```

create new variables  
```{r message=FALSE, warning=FALSE}
library(dplyr)
cidp <- cidp %>%
  mutate(age_dx = round(as.numeric(date_Dx - dob)/365)) %>%
  mutate(fu_duration = round(as.numeric(date_lastvisit - date_Dx)/30)) %>%
  mutate(onset2dx = round(as.numeric(date_Dx - date_onset)/30)) %>%
  mutate(outcome = factor(ifelse(mRS_last < 3, "favorable", "poor"))) %>%
  mutate(mRS_chage = mRS_last - mRS_initial) %>%
  mutate(tx.response = factor(ifelse(mRS_chage > 0, "non-responder", 
       ifelse(mRS_chage < 0, "responder",
              ifelse(mRS_last < 3, "responder", "non-responder")
              )
       )
       )
       )
```


## 탐색적 데이터 분석

### correlation plot: correlation between edx parameters 
```{r message=FALSE}
edx.mat = as.matrix(edx[,-1])
rownames(edx.mat) = edx$id
library("PerformanceAnalytics")
par(mar=c(3,5,3,5))
png(filename = "correlationPlot.png", width = 7, height = 5, units = "in", res = 300)
chart.Correlation(edx.mat, histogram=F, method = "spearman", pch=19)
dev.off()
# Significance codes 0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
# Histogram with kernel density estimation and rug plot.
# Scatter plot with fitted line
```

```{r}
edx.df = data.frame(edx.mat)
cor.test(edx.df$DML, edx.df$DUR, method = "pearson")
cor.test(edx.df$DML, edx.df$NCV, method = "pearson") # p=0.017
cor.test(edx.df$DML, edx.df$FL, method = "pearson") # p=0.0018
cor.test(edx.df$CB, edx.df$TD, method = "pearson") # p=0.049
cor.test(edx.df$NCV, edx.df$CB, method = "pearson") # p=0.017
cor.test(edx.df$NCV, edx.df$TD, method = "pearson") # p=0.033
cor.test(edx.df$NCV, edx.df$CMAP, method = "pearson") # p=0.004
cor.test(edx.df$FL, edx.df$DUR, method = "pearson") # p=0.028
cor.test(edx.df$CMAP, edx.df$, method = "pearson") # p=0.028
```

> As expected, we can find significant positive correlation between DML and DUR (demyelinating features at distal segments), and 
weak but significant correlations among CB, TD and NCV (demyelinating features at intermediate segments).   

> Of note, all the correlations were weak to modest with correlation coefficients not greater than 0.6 in all pairs. In addition, relationships among parameters are rather complex. For instance. FL is signficantly correlated with DML, DUR and NCV, but not with CB and TD. dCMAP amplitude, conventionally regarded as a marker of axonal loss, is significantly correlated with DML, NCV and CB (suggesting axonal damage secondary to demyelination), but not with DUR, TD and FL. 

### Network graph: visualizing complex relationships between conduction parameters

To visualize which conduction parameters are significantly related to each other, we plotted a network graph (node represents each parameter, line correlation between parameters)

```{r message=FALSE}
library(corrr)
edx.mat %>% correlate() %>% network_plot(min_cor=0.2)
# The min_cor parameter is the minimum correlation coefficient required to display a line between variables.
```
The closer each parameter is to each other, the higher the relationship, while the opposite is true for widely spaced parameters. The color of the line represents the direction of the correlation (blue for pos, red for neg) while the line shade and thickness represent the strength of the relationship.

## 모형화

Next, we sought to identify distinct subgroups of patients who are similar in the pattern of conduction parameters. We used hierachical clustering for the EDX data-based partitioning of patients into subgroups.   

### Hierachical clustering 

normalization: z-transformatioon
```{r}
cal_z_score <- function(x){
  (x - mean(x)) / sd(x)
} # scale with mean (center) and sd (sdev)
edx_norm <- apply(edx.mat, 2, cal_z_score) # column-wise z score calculation
```

distance calculation
```{r}
edx_dist = dist(edx_norm) # Euclidean distance, row-wise
```

hierachical clustering
```{r}
edx_hclust = hclust(edx_dist, method = "complete")
```
**Complete-linkage** clustering is one of several methods of agglomerative hierarchical clustering. At the beginning of the process, each element is in a cluster of its own. The clusters are then sequentially combined into larger clusters until all elements end up being in the same cluster. At each step, the two clusters separated by the shortest distance are combined. The definition of 'shortest distance' is what differentiates between the different agglomerative clustering methods. In complete-linkage clustering, the link between two clusters contains all element pairs, and the distance between clusters equals the distance between those two elements (one in each cluster) that are farthest away from each other. The shortest of these links that remains at any step causes the fusion of the two clusters whose elements are involved. The method is also known as **farthest neighbour clustering**. The result of the clustering can be visualized as a dendrogram, which shows the sequence of cluster fusion and the distance at which each fusion took place**

plot dendrogram
```{r message=FALSE}
# load package
library(dendextend)
as.dendrogram(edx_hclust) %>%
  plot()
```

### Determine the optimal number of clusters which suitably fit the edx dataset 

In the literature, a wide variety of measures have been proposed to validate the results of clustering, and to find the optimal number of clusters. All these clustering validity measures combine information about **compactness within clusters** and **separation between clusters**, as well as other factors, such as geometric or statistical properties of the data, the number of data objects and dissimilarity or similarity measurements. We used NbClust (R package) which provides multiple (30 in total) validity indices, and determined the best number of clusters accordiing to the majority rule, i.e., the number of clusters proposed as the best clustering scheme by the most indices.  

```{r} 
library(NbClust)
set.seed(1)
cl.validity = NbClust(edx_norm, distance = "euclidean", 
       method = "complete", min.nc = 2, max.nc = 10, 
        index = "all") # partition rows based on columns 
cl.validity$Best.nc 
# Hubert and D index are graphical methods. Hence, values of these indices are set to zero. 
```

the optimal number of clusters
```{r}
cluster = cutree(edx_hclust, 2) # number of cluster = 2
cluster
```

assign cluster membership
```{r}
cluster_membership = data.frame(cluster = ifelse(cluster == 1, "C1", "C2"))
```


### Heatmap

load package
```{r}
library(pheatmap)
```

heatmap with cluster membership and subtype annotation
```{r}
subtype = cidp$subtype
membership = cbind(cluster_membership, subtype)
par(mar=c(3,3,3,3))
par(oma=c(3,3,3,3))
png(filename = "heatmap.png", height=4, width=9, units = 'in', res = 300)
pheatmap(t(edx_norm), 
         cluster_rows = F,
         cellheight = 20,
         cellwidth = 8,
         annotation_col = membership)
dev.off()
```

### Cluster validation: external validity

comparisons of edx parameters btw clusters: box plot 
```{r}
library(tidyr)
edx_cluster = cbind(edx, cluster_membership)
edx_long = gather(edx_cluster, key=param, value=value, 
                  DML:CMAP, factor_key = TRUE) # wide to long format

library(ggplot2)
png(filename = 'Fig3.png', width = 10, height = 5, units = "in", res = 300)
ggplot(edx_long, aes(x=cluster, y=value, fill=cluster)) + geom_boxplot(lwd=0.2, outlier.size=0.3) + facet_grid(.~param) + theme(plot.margin = unit(c(0.6,1.6,0.6,1.6),"in"))
dev.off()
```

comparisons of edx parameters btw clusters: descriptive statistics
```{r message=TRUE, warning=FALSE}
edx_long %>%
  group_by(param, cluster) %>%
  summarize(mean = mean(value), sd = sd(value)) 
edx_long %>%
  group_by(param) %>%
  summarize(p.value = wilcox.test(value~cluster)$p.value)
```

comparisons of clinical variables (categorical) btw clusters: summary
```{r}
cidp.cluster = cbind(cidp, cluster_membership)
cat <- cidp.cluster[,c("cluster", "sex", "atrophy", "ataxia", "cNerve", "tremor", "subtype", "diabetes", "ckd", "M_prot", "mgp", "lchain", "mRS_initial", "mRS_last", "steroid", "IVIG", "others", "outcome", "tx.response")]  
aggregate(cat, by=list(cat$cluster), summary)
```

comparisons of clinical variables (categorical) btw clusters: statistics
```{r}
cat_long = gather(cat, key = variable, value = value,
                     sex:tx.response, factor_key = T)
cat_long %>%
  group_by(variable) %>%
  summarize(p.value = fisher.test(table(cluster, value))$p.value)
```

> significant difference btw clusters in outcome (p=0.023) and margical difference in subtype (p=0.063)

comparisons of clinical variables (continuous) btw clusters: summary
```{r}
cont <- cidp.cluster[,c("cluster", "age_dx", "fu_duration", "onset2dx", "csf_prot")] 
aggregate(cont, by=list(cont$cluster), summary)
```

comparisons of clinical variables (categorical) btw clusters: statistics
```{r}
cont_long = gather(cont, key = variable, value = value,
                     age_dx:csf_prot)
cont_long %>%
  group_by(variable) %>%
  summarize(p.value = wilcox.test(value~cluster)$p.value)
```

### outcome predictors: logistic regression 

logistic regression; univariate 
```{r}
logist.fxn= function(var){
  formula = as.formula(paste("outcome ~", var))
  res.logist = glm(formula, data = df, family = "binomial")
  coef(summary(res.logist))[,"Pr(>|z|)"]
}
df = cidp.cluster[,c("outcome", "cluster", "DML", "DUR", "NCV", "CB", "TD", "FL", "CMAP", "sex", "age_dx", "fu_duration", "onset2dx", "subtype", "mRS_initial", "mRC_initial", "mRS_last", "diabetes", "ckd", "atrophy", "ataxia", "cNerve", "tremor", "csf_prot", "M_prot", "mgp", "lchain", "steroid", "IVIG", "others")] 

logist.fxn= function(var){
  formula = as.formula(paste("outcome ~", var))
  res.logist = glm(formula, data = df, family = "binomial")
  cbind(exp(coef(res.logist)), exp(confint(res.logist)))
  # coef(summary(res.logist))[,"Pr(>|z|)"]
}

variables = colnames(df)[2:30]
res = lapply(variables, logist.fxn)
names(res) = variables
res
```

```{r}
mod = glm(outcome~cluster, data = df, family = "binomial")
summary(mod)
```

select variables with p < 0.1 in univariate logistic regression  
: DML, DUR, NCV, FL, mRS_initial, mRC_initial, diabetes, IVIG
and put those into multivariate analysis 
```{r}
glm.fit = glm(outcome ~ DML + DUR + NCV + FL + mRS_initial + mRC_initial + diabetes + IVIG, data = cidp.cluster, family = "binomial")
step(glm.fit) # backward stepwise
final.glm.fit = glm(formula = outcome ~ mRS_initial + DUR + FL + IVIG, family = "binomial", 
    data = cidp.cluster)
summary(final.glm.fit)
exp(coef(final.glm.fit))
exp(confint(final.glm.fit))
```

> initial disability (measured by modified rankin scales), duration of distal CMAP and FL are significant predictors of poor outcome (hazard ratio, 6.1, 0.96, 0.93)

## 보고서 작성

> Electrodiagnostic data-driven clustering in CIDP identifies a prognostically different subgroup of patients

EDX data-based clustering partitioned definite CIDP patients into two subgroups. EDX features in one subgroup (cluster 2) is characerized by prominent demyelinating features along with marked reduction of dCMAP amplitudes. The long-term treatment outcome was significantly different between two subgroups, with favorable outcome in all patients of cluster 2. Initial disability, a strong predictor of long-term outcome, was not different between between two clusters, which means that the EDX pattern of cluster 2 does not relate to disability. 


> CMAP vs. DML

relationships between CMAP and DML are different between EDX clusters 
: significant negative correlation in cluster 1, but not in cluster 2. Furthermore, within cluster 1, the relationship in patients with favorable outcome is similar to that in patients of cluster 2. 

```{r}
ggplot(cidp.cluster, aes(x=DML, y=CMAP, color=outcome)) + 
  geom_point() + 
  geom_smooth(method = "lm", aes(fill=outcome)) + 
  facet_wrap(~cluster)
```

statistics
```{r}
c1 = subset(cidp.cluster, cluster=="C1")
c2 = subset(cidp.cluster, cluster=="C2")
cor.test(c1$DML, c1$CMAP, method = "spearman")
cor.test(c2$DML, c2$CMAP, method = "spearman")
c1.fav = subset(c1, outcome == "favorable")
c1.poo = subset(c1, outcome == "poor")
cor.test(c1.fav$DML, c1.fav$CMAP, method = "spearman")
cor.test(c1.poo$DML, c1.poo$CMAP, method = "spearman")
```

Reduced distal CMAP amplitude is considered generally to reflect axonal damage, and was reported to be pronounced in non-responders of IVIg treatment ((Iijima et al., Neurology, 2005). However, it should be emphasized that it also can be caused by other pathologies, for example, severe demyelinating conduction block at the distal segments. The present study highlights that the reduced dCMAP may not necessarily reflect axonal pathology in CIDP. If reduced dCMAP amplitudes are accompanied by marked prolongation of DML as in cluster 2, active treatment would lead to favorable outcome. 

DUR is another demyelinating parameter at distal segments. However, we could not find any signficant correlation between CMAP and DUR. This is also the case in subgroup analysis. Unlike DML, DUR tends to decrease as dCMAP amplitude is reduced. In such cases, DUR might reflect demyelinating pathology not as sensitive as DML. 

```{r}
ggplot(cidp.cluster, aes(x=DUR, y=CMAP, color=outcome)) + 
  geom_point() + 
  geom_smooth(method = "lm", aes(fill=outcome)) + 
  facet_wrap(~cluster)
```



